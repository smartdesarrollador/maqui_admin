<div class="container mx-auto px-4 py-8">
  <!-- Filtros -->
  <div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-xl font-semibold mb-4">Filtros de búsqueda</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Estado -->
      <div class="form-group">
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Estado</label
        >
        <select
          class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
          [ngModel]="filters().estado"
          (ngModelChange)="applyFilters({ estado: $event })"
        >
          <option value="">Todos</option>
          <option value="pendiente">Pendiente</option>
          <option value="aprobada">Aprobada</option>
          <option value="rechazada">Rechazada</option>
        </select>
      </div>

      <!-- Rango de precios -->
      <div class="form-group">
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Precio mínimo</label
        >
        <input
          type="number"
          class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
          [ngModel]="filters().precio_min"
          (ngModelChange)="applyFilters({ precio_min: $event })"
          placeholder="Precio mínimo"
        />
      </div>

      <div class="form-group">
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Precio máximo</label
        >
        <input
          type="number"
          class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
          [ngModel]="filters().precio_max"
          (ngModelChange)="applyFilters({ precio_max: $event })"
          placeholder="Precio máximo"
        />
      </div>

      <!-- Búsqueda por cliente -->
      <div class="form-group">
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Cliente</label
        >
        <input
          type="text"
          class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
          [ngModel]="filters().cliente"
          (ngModelChange)="applyFilters({ cliente: $event })"
          placeholder="Buscar por cliente"
        />
      </div>
    </div>
  </div>

  <!-- Tabla de cotizaciones -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="min-w-full divide-y divide-gray-200">
      <!-- Cabecera de tabla -->
      <div class="bg-gray-50">
        <div
          class="grid grid-cols-6 gap-4 px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
        >
          <div class="cursor-pointer" (click)="sort('created_at')">
            Fecha @if (filters().sort_by === 'created_at') {
            <span>{{ filters().sort_order === "asc" ? "↑" : "↓" }}</span>
            }
          </div>
          <div>Cliente</div>
          <div>Moto</div>
          <div class="cursor-pointer" (click)="sort('precio_total')">
            Precio Total @if (filters().sort_by === 'precio_total') {
            <span>{{ filters().sort_order === "asc" ? "↑" : "↓" }}</span>
            }
          </div>
          <div class="cursor-pointer" (click)="sort('estado')">
            Estado @if (filters().sort_by === 'estado') {
            <span>{{ filters().sort_order === "asc" ? "↑" : "↓" }}</span>
            }
          </div>
          <div>Acciones</div>
        </div>
      </div>

      <!-- Cuerpo de tabla -->
      <div class="divide-y divide-gray-200">
        @if (loading()) {
        <div class="text-center py-4">
          <div
            class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"
          ></div>
        </div>
        } @else if (cotizaciones().length === 0) {
        <div class="text-center py-4 text-gray-500">
          No se encontraron cotizaciones
        </div>
        } @else { @for (cotizacion of cotizaciones(); track cotizacion.id) {
        <div class="grid grid-cols-6 gap-4 px-6 py-4 hover:bg-gray-50">
          <div>{{ cotizacion.created_at | date : "dd/MM/yyyy" }}</div>
          <div>
            {{ cotizacion.cliente?.nombre }} {{ cotizacion.cliente?.apellido }}
          </div>
          <div>{{ cotizacion.moto?.nombre }}</div>
          <div>{{ formatCurrency(cotizacion.precio_total) }}</div>
          <div>
            <span
              [class]="
                'px-2 inline-flex text-xs leading-5 font-semibold rounded-full ' +
                (cotizacion.estado === 'aprobada'
                  ? 'bg-green-100 text-green-800'
                  : cotizacion.estado === 'rechazada'
                  ? 'bg-red-100 text-red-800'
                  : 'bg-yellow-100 text-yellow-800')
              "
            >
              {{ cotizacion.estado }}
            </span>
          </div>
          <div>
            <button
              class="text-primary-600 hover:text-primary-900"
              (click)="openDetailModal(cotizacion)"
            >
              Ver detalles
            </button>
          </div>
        </div>
        } }
      </div>
    </div>

    <!-- Paginación -->
    @if (totalItems() > 0) {
    <div
      class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6"
    >
      <div class="flex-1 flex justify-between sm:hidden">
        <button
          [disabled]="filters().page === 1"
          (click)="onPageChange(filters().page! - 1)"
          class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
          [class.opacity-50]="filters().page === 1"
        >
          Anterior
        </button>
        <button
          [disabled]="filters().page! * filters().per_page! >= totalItems()"
          (click)="onPageChange(filters().page! + 1)"
          class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50"
          [class.opacity-50]="
            filters().page! * filters().per_page! >= totalItems()
          "
        >
          Siguiente
        </button>
      </div>
      <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
        <div>
          <p class="text-sm text-gray-700">
            Mostrando
            <span class="font-medium">{{
              (filters().page! - 1) * filters().per_page! + 1
            }}</span>
            a
            <span class="font-medium">
              {{
                Math.min(filters().page! * filters().per_page!, totalItems())
              }}
            </span>
            de
            <span class="font-medium">{{ totalItems() }}</span>
            resultados
          </p>
        </div>
        <div>
          <nav
            class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px"
          >
            @for (page of getPages(); track page) {
            <button
              (click)="onPageChange(page)"
              [class]="
                'relative inline-flex items-center px-4 py-2 border text-sm font-medium ' +
                (page === filters().page
                  ? 'z-10 bg-primary-50 border-primary-500 text-primary-600'
                  : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50')
              "
            >
              {{ page }}
            </button>
            }
          </nav>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Modal de detalles -->
  @if (showModal()) {
  <div
    class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4"
  >
    <div
      class="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto"
    >
      <div class="px-6 py-4 border-b border-gray-200">
        <h3 class="text-lg font-medium text-gray-900">
          Detalles de la Cotización
        </h3>
      </div>

      <div class="px-6 py-4">
        @if (selectedCotizacion()) {
        <div class="space-y-4">
          <!-- Información del cliente -->
          <div>
            <h4 class="font-medium text-gray-900">Cliente</h4>
            <p>
              {{ selectedCotizacion().cliente?.nombre }}
              {{ selectedCotizacion().cliente?.apellido }}
            </p>
          </div>

          <!-- Información de la moto -->
          <div>
            <h4 class="font-medium text-gray-900">Moto</h4>
            <p>
              {{ selectedCotizacion().moto?.nombre }} -
              {{ selectedCotizacion().moto?.modelo }}
            </p>
          </div>

          <!-- Accesorios -->
          @if (selectedCotizacion().accesorios?.length) {
          <div>
            <h4 class="font-medium text-gray-900">Accesorios</h4>
            <ul class="list-disc list-inside">
              @for (accesorio of selectedCotizacion().accesorios; track
              accesorio.id) {
              <li>{{ accesorio.nombre }}</li>
              }
            </ul>
          </div>
          }

          <!-- Repuestos -->
          @if (selectedCotizacion().repuestos?.length) {
          <div>
            <h4 class="font-medium text-gray-900">Repuestos</h4>
            <ul class="list-disc list-inside">
              @for (repuesto of selectedCotizacion().repuestos; track
              repuesto.id) {
              <li>{{ repuesto.nombre }}</li>
              }
            </ul>
          </div>
          }

          <!-- Información de financiamiento -->
          @if (selectedCotizacion().financiamiento) {
          <div>
            <h4 class="font-medium text-gray-900">Financiamiento</h4>
            <p>Cuotas: {{ selectedCotizacion().financiamiento.cuotas }}</p>
            <p>
              Monto mensual:
              {{
                formatCurrency(
                  selectedCotizacion().financiamiento.monto_mensual
                )
              }}
            </p>
          </div>
          }

          <!-- Precio total -->
          <div>
            <h4 class="font-medium text-gray-900">Precio Total</h4>
            <p class="text-lg font-semibold text-primary-600">
              {{ formatCurrency(selectedCotizacion().precio_total) }}
            </p>
          </div>
        </div>
        }
      </div>

      <div class="px-6 py-4 border-t border-gray-200">
        <button
          type="button"
          (click)="closeModal()"
          class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:w-auto"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
  }
</div>
